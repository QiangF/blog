---
layout: post
author: Train
description: "向量代数法推导已知经纬度的两点间的球面距离和方位角"
keywords: "经纬度, 球面距离, 方位角, 向量代数, 空间解析几何"
mathjax: true
---

[前一篇文章](https://dothinking.github.io/blog/2017/03/08/%E7%90%83%E9%9D%A2%E8%B7%9D%E7%A6%BB%E4%B8%8E%E6%96%B9%E4%BD%8D%E8%A7%92%E5%85%AC%E5%BC%8F%E7%9A%84%E6%8E%A8%E5%AF%BC-%E8%A7%A3%E4%B8%89%E8%A7%92%E5%BD%A2%E6%B3%95.html)从几何的角度，
使用常规的解三角形法推导了球面上两点间的最短距离、方位角公式；本文将从代数的角度，直接使用向量计算的方法进行推导。

## 概述

本文需要推导的公式都是基于标准球体的假设，并且经纬度坐标的定义类似于球坐标系，因此可以使用球坐标系来描述空间位置。
下图显示了经纬度的定义和标准球坐标系不同之处，其中左图为经纬度等物理量在单位球中的示意，右图为标准球坐标系的定义。

<div align='center'><img src="{{ "/images/2017-03-09-01.png" | prepend: site.baseurl }}"></div>

`纬度`是地球上某点与球心的连线与地球赤道面所成的线面角（如图所示$\varphi$），北纬为正数，南纬为负数。

`经度`是地球上某点经线平面与本初子午面所成的二面角（如图所示的$\lambda$），东经为正数，西经为负数。

球面上两点P、Q的最短距离为过P、Q的大圆对应两点之间的劣弧的长度（如图实线所示$\overset{\frown}{PQ}$）。

`方位角`是从某点的指北方向线起，依顺时针方向到目标方向线之间的水平夹角（如图所示$\theta$）。

根据上述定义可知，在单位球面上，经纬度$(\varphi,\lambda)$与球坐标$(\Phi, \Theta)$之间的对应关系为：

\begin{align\*}
    \Phi   &= \frac{\pi}{2} - \varphi \\\\\\
    \Theta &=
            \begin{cases}
                \lambda + 2\,\pi   & -\pi \le \lambda \le 0 \\\\\\
                \lambda            & 0 \le \lambda \le \pi
            \end{cases}
\end{align\*}

于是，直角坐标系与球坐标系的对应关系

$$
\left\{ 
    \begin{array}{c}
        x = \sin\Phi \cos\Theta \\
        y = \sin\Phi \sin\Theta \\
        z = \cos\Phi
    \end{array}
\right.
$$

转换到经纬度坐标系下为：

$$
\left\{ 
    \begin{array}{c}
        x = \cos\varphi \cos\lambda \\
        y = \cos\varphi \sin\lambda \\
        z = \sin\varphi
    \end{array}
\right.
$$

### 球面距离公式及其推导

球面距离$d$的常用计算公式为`Haversine`公式[[^1],[^2]]：

\begin{align\*}
a &= \sin^2\frac{\Delta\varphi}{2} + \cos\varphi_1 \cos\varphi_2 \, sin^2\frac{\Delta\lambda}{2}\\\\\\
\delta &= 2\,atan2\frac{\sqrt{a}}{\sqrt{1-a}} \\\\\\
d &= R\,\delta\\\\\\
\tag{I}
\end{align\*}

其中，$\varphi$是纬度，$\lambda$是经度，$R$是地球平均半径（$R=6371km$）。$\Delta\varphi=\varphi_2-\varphi_1$，$\Delta\lambda=\lambda_2-\lambda_1$
分别为纬度、经度的差值。注意，代入计算中的经、纬度为换算后的弧度值。

**分析：** 根据经纬度得到P、Q点的笛卡尔坐标，代入两点间距离公式计算球心角对应的弦长，最终得到球心角。

P、Q在笛卡尔坐标系下表示为：

$$
\left\{ 
    \begin{array}{c}
        x_1 = \cos\varphi_1 \cos\lambda_1 \\
        y_1 = \cos\varphi_1 \sin\lambda_1 \\
        z_1 = \sin\varphi_1
    \end{array}
\right. 
\quad
\left\{ 
    \begin{array}{c}
        x_2 = \cos\varphi_2 \cos\lambda_2 \\
        y_2 = \cos\varphi_2 \sin\lambda_2 \\
        z_2 = \sin\varphi_2
    \end{array}
\right.
$$

代入两点间距离公式：

\begin{align\*}
PQ^2 &= (\Delta x)^2 + (\Delta y)^2 + (\Delta z)^2 \\\\\\
     &= (\cos\varphi_1 \cos\lambda_1 - \cos\varphi_2 \cos\lambda_2)^2 + 
        (\cos\varphi_1 \sin\lambda_1 - \cos\varphi_2 \sin\lambda_2)^2 + 
        (\sin\varphi_1 - \sin\varphi_2)^2 \\\\\\
     &= 2 - 2\,\sin\varphi_1 \sin\varphi_2 - 2\,\cos\varphi_1 \cos\varphi_2 \cos\Delta\lambda\\\\\\
     &= 2 - 2\,\cos\Delta\varphi + 4\,\cos\varphi_1 \cos\varphi_2 \sin^2\frac{\Delta\lambda}{2}\\\\\\
     &= 4\,sin^2\frac{\Delta\varphi}{2} + 4\,\cos\varphi_1 \cos\varphi_2 \sin^2\frac{\Delta\lambda}{2}
\end{align\*}

令$a=(PQ/2)^2$即可得到`Haversine`公式。

以上式为基础，可以进一步推导余弦形式的球面距离公式：

$$
    a = \sin^2\frac{\delta}{2}
$$

于是，

\begin{align\*}
    \cos\delta &= 1 - 2\,\sin^2\frac{\delta}{2} = 1 - 2\,a \\\\\\
               &= 1 - 2\,sin^2\frac{\Delta\varphi}{2}- 2\,\cos\varphi_1 \cos\varphi_2 \sin^2\frac{\Delta\lambda}{2}\\\\\\
               &= \cos\Delta\varphi - \cos\varphi_1 \cos\varphi_2 \left( 1 - \cos\Delta\lambda \right) \\\\\\
               &= \left( \cos\Delta\varphi - \cos\varphi_1 \cos\varphi_2 \right) + \cos\varphi_1 \cos\varphi_2 \cos\Delta\lambda \\\\\\
               &= \sin\varphi_1 \sin\varphi_2 + \cos\varphi_1 \cos\varphi_2 \cos\Delta\lambda
    \tag{*}\label{eq:1}
\end{align\*}


### 方位角公式及其推导

方位角$\theta$的计算公式：

$$
\theta = atan2\frac{\sin\Delta\lambda \cos\varphi_2}{\cos\varphi_1 \sin\varphi_2-\sin\varphi_1 \cos\varphi_2\,\cos\Delta\lambda}
\tag{II}
$$

**分析：** 如下图所示，P点处方位角$\theta$为过P点的两个大圆在该点处切线方向向量$\vec{\tau_1},\,\vec{\tau_2}$的夹角。 

<div align='center'><img src="{{ "/images/2017-03-09-02.png" | prepend: site.baseurl }}"></div>

\begin{align*}
    \vec{\tau_1} &= \overrightarrow{OP} \times \vec{n_1} = \overrightarrow{OP} \times \left( \overrightarrow{OQ} \times \overrightarrow{OP} \right) \\\\\\
    \vec{\tau_2} &= \overrightarrow{OP} \times \vec{n_2} = \overrightarrow{OP} \times \left( \overrightarrow{ON} \times \overrightarrow{OP} \right)
\end{align\*}

其中，

\begin{align*}
    \overrightarrow{OP} &= \left( \cos\varphi_1 \cos\lambda_1 \, \cos\varphi_1 \sin\lambda_1 \, \sin\varphi_1 \right)\\\\\\
    \overrightarrow{OQ} &= \left( \cos\varphi_2 \cos\lambda_2 \, \cos\varphi_2 \sin\lambda_2 \, \sin\varphi_2 \right)\\\\\\
    \overrightarrow{ON} &= \left( 0, \, 0, \, 1\right)
\end{align\*}

易知$ \left | \overrightarrow{OP} \right | = \left |\overrightarrow{OQ} \right | = \left |\overrightarrow{ON} \right | = 1$

$\bm{a}$

$\bm{\alpha}$

参考向量叉积的运算规律[[^3],[^4]]，进行如下计算：

\begin{align*}
    \vec{\tau_1} \cdot \vec{\tau_2} &= \left[ \overrightarrow{OP} \times \left( \overrightarrow{OQ} \times \overrightarrow{OP} \right) \right] \cdot
                \left[ \overrightarrow{OP} \times \left( \overrightarrow{ON} \times \overrightarrow{OP} \right) \right]\\\\\\
            &= \overrightarrow{OP}
\end{align\*}


### 已知起始点、方位角及距离，求目标位置

已知起始点经纬度$P(\varphi_1,\lambda_1)$，方向角$\theta$及球面距离$d$，计算目标位置$Q(\varphi_2,\lambda_2)$的公式为：

\begin{align\*}
\varphi_2 &= asin \left( \sin\varphi_1 \cos\delta + \cos\varphi_1 \sin\delta \cos\theta \right)\\\\\\
\lambda_2 &= \lambda_1 + atan2 \frac{\sin\theta \sin\delta \cos\varphi_1}{\cos\delta-\sin\varphi_1 \sin\varphi_2}
\tag{III}
\end{align\*}

其中，球心角$\delta = d/R$。

**分析：** 根据球面距离公式和方位角公式反求目标位置即可。




## 参考资料

[^1]: [1] [Calculate distance, bearing and more between Latitude/Longitude points](http://www.movable-type.co.uk/scripts/latlong.html)  

[^2]: [2] [Haversine formula](https://en.wikipedia.org/wiki/Haversine_formula)  

[^3]: [2] [Cross product](https://en.wikipedia.org/wiki/Cross_product)  

[^4]: [2] [Triple product](https://en.wikipedia.org/wiki/Triple_product)  

