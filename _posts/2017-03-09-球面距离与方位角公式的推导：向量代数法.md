---
layout: post
author: Train
description: "向量代数法推导已知经纬度的两点间的球面距离和方位角"
keywords: "经纬度, 球面距离, 方位角, 向量代数, 空间解析几何"
mathjax: true
---

[前一篇文章](https://dothinking.github.io/blog/2017/03/08/%E7%90%83%E9%9D%A2%E8%B7%9D%E7%A6%BB%E4%B8%8E%E6%96%B9%E4%BD%8D%E8%A7%92%E5%85%AC%E5%BC%8F%E7%9A%84%E6%8E%A8%E5%AF%BC-%E8%A7%A3%E4%B8%89%E8%A7%92%E5%BD%A2%E6%B3%95.html)从几何的角度，
使用常规的解三角形法推导了球面上两点间的最短距离、方位角公式；本文将从代数的角度，直接使用向量计算的方法进行推导。

## 概述

本文需要推导的公式都是基于标准球体的假设，并且经纬度坐标的定义类似于球坐标系，因此可以使用球坐标系来描述空间位置。
下图显示了经纬度的定义和标准球坐标系不同之处，其中左图为经纬度等物理量在单位球中的示意，右图为标准球坐标系的定义。

<div align='center'><img src="{{ "/images/2017-03-09-01.png" | prepend: site.baseurl }}"></div>

`纬度`是地球上某点与球心的连线与地球赤道面所成的线面角（如图所示$\varphi$），北纬为正数，南纬为负数。

`经度`是地球上某点经线平面与本初子午面所成的二面角（如图所示的$\lambda$），东经为正数，西经为负数。

球面上两点P、Q的最短距离为过P、Q的大圆对应两点之间的劣弧的长度（如图实线所示$\overset{\frown}{PQ}$）。

`方位角`是从某点的指北方向线起，依顺时针方向到目标方向线之间的水平夹角（如图所示$\theta$）。

根据上述定义可知，在单位球面上，经纬度$(\varphi,\lambda)$与球坐标$(\Phi, \Theta)$之间的对应关系为：

\begin{align\*}
    \Phi   &= \frac{\pi}{2} - \varphi \\\\\\
    \Theta &=
            \begin{cases}
                \lambda + 2\,\pi   & -\pi \le \lambda \le 0 \\\\\\
                \lambda            & 0 \le \lambda \le \pi
            \end{cases}
\end{align\*}

于是，直角坐标系与球坐标系的对应关系

$$
    \left\lbrace
        \begin{aligned} 
            x &= \sin\Phi \cos\Theta \\\\ 
            y &= \sin\Phi \sin\Theta \\\\
            z &= \cos\Phi
        \end{aligned} 
    \right.
$$

转换到经纬度坐标系下为：

$$
    \left\{
        \begin{aligned} 
            x &= \cos\Phi \cos\Theta \\\\ 
            y &= \cos\Phi \sin\Theta \\\\
            z &= \sin\Phi
        \end{aligned} 
    \right.
$$

### 球面距离公式及其推导

球面距离$d$的常用计算公式为`Haversine`公式[[^1],[^2]]：

\begin{align\*}
a &= \sin^2\frac{\Delta\varphi}{2} + \cos\varphi_1 \cos\varphi_2 \, sin^2\frac{\Delta\lambda}{2}\\\\\\
\delta &= 2\,atan2\frac{\sqrt{a}}{\sqrt{1-a}} \\\\\\
d &= R\,\delta\\\\\\
\tag{I}
\end{align\*}

其中，$\varphi$是纬度，$\lambda$是经度，$R$是地球平均半径（$R=6371km$）。$\Delta\varphi=\varphi_2-\varphi_1$，$\Delta\lambda=\lambda_2-\lambda_1$
分别为纬度、经度的差值。

注意，代入计算中的经、纬度为换算后的弧度值。

**推导：**

思路：根据经纬度得到P、Q点在直角坐标系下的坐标，然后代入两点间距离公式，即可得到球心角对应的弦长。

在球面三角形NPQ中直接使用球面三角形的余弦定理（Spherical law of cosines）[[^3],[^4]]得到

\begin{equation\*}
  \cos\delta = \sin\varphi_1 \sin\varphi_2 + \cos\varphi_1 \cos\varphi_2 \cos\Delta\lambda
  \tag{*}\label{eq:1}
\end{equation\*}

上式即可求出$\overset{\frown}{PQ}$对应的球心角，但是，当P、Q相邻很近（例如，数米之间）即$\delta$趋近于0时，$\cos\delta$将趋近于1（0.99999999）。
其后果是对于低浮点精度（low floating-point precision）的计算设备，可能由于舍入误差而造成错误的结果。当然，对于现代的64位浮点数运算
的计算机，一般不会出现上述问题。

为了使上述公式具有更好的计算兼容性，在$\Delta{OPQ}$中使用平面三角形余弦定理

\begin{align\*}
{PQ}^2 &= {OP}^2 + {OQ}^2 - 2\,{OP}\,{OQ}\,\cos\delta \\\\\\
       &= 2 - 2\,( \sin\varphi_1 \sin\varphi_2 + \cos\varphi_1 \cos\varphi_2 \cos\Delta\lambda )\\\\\\
       &= 2 - 2\,\left[ \sin\varphi_1 \sin\varphi_2 + \cos\varphi_1 \cos\varphi_2 \left( 1-2\,\sin^2\frac{\Delta\lambda}{2} \right) \right ]\\\\\\
       &= 2 - 2(\sin\varphi_1 \sin\varphi_2 + \cos\varphi_1 \cos\varphi_2) + 4\,\cos\varphi_1 \cos\varphi_2\,\sin^2\frac{\Delta\lambda}{2} \\\\\\
       &= 2\,\left( 1-\cos\Delta\varphi \right)  + 4\,\cos\varphi_1 \cos\varphi_2 \,\sin^2\frac{\Delta\lambda}{2} \\\\\\
       &= 4\,\sin^2\frac{\Delta\varphi}{2} + 4\,\cos\varphi_1 \cos\varphi_2 \,\sin^2\frac{\Delta\lambda}{2} \\\\\\
\end{align\*}

令$a=(PQ/2)^2$，则上式写为：

$$
a = \sin^2\frac{\Delta\varphi}{2} + \cos\varphi_1 \cos\varphi_2 \,\sin^2\frac{\Delta\lambda}{2}
$$

进而得到球心角$\delta$为：

$$
\delta = 2\,atan2\frac{\sqrt{a}}{\sqrt{1-a}}
$$

### 方位角公式及其推导

方位角$\theta$的计算公式：

$$
\theta = atan2\frac{\sin\Delta\lambda \cos\varphi_2}{\cos\varphi_1 \sin\varphi_2-\sin\varphi_1 \cos\varphi_2\,\cos\Delta\lambda}
\tag{II}
$$

**推导：**

思路：球面三角形的正弦定理和余弦定理。 

在球面三角形NPQ中分别使用正弦定理和余弦定理：

\begin{align\*}
\frac{\sin\theta}{\cos\varphi_2} &= \frac{\sin\Delta\lambda}{\sin\delta} \\\\\\
\sin\varphi_2 &= \sin\varphi_1 \cos\delta + \cos\varphi_1 \sin\delta \, \cos\theta
\tag{**}\label{eq:2}
\end{align\*}

得到：

\begin{align\*}
\sin\theta &= \frac{\cos\varphi_2}{\sin\delta} \, \sin\Delta\lambda\\\\\\
\cos\theta &= \frac{\sin\varphi_2-\sin\varphi_1 \cos\delta}{\cos\varphi_1 \sin\delta}
\end{align\*}

两式相除，并将式\eqref{eq:1}代入得：

\begin{align\*}
\tan\theta &= \frac{\sin\Delta\lambda \cos\varphi_1 \cos\varphi_2}{\sin\varphi_2-\sin\varphi_1 \cos\delta} \\\\\\
           &= \frac{\sin\Delta\lambda \cos\varphi_1 \cos\varphi_2}{\sin\varphi_2-\left( \sin^2\varphi_1 \sin\varphi_2 + \sin\varphi_1 \cos\varphi_1 \cos\varphi_2 \cos\Delta\lambda  \right)}\\\\\\
           &= \frac{\sin\Delta\lambda \cos\varphi_2}{ \cos\varphi_1 \sin\varphi_2 - \sin\varphi_1 \cos\varphi_2 \cos\Delta\lambda}
\end{align\*}

取反函数即可得到方位角$\theta$的表达式。

### 已知起始点、方位角及距离，求目标位置

已知起始点经纬度$P(\varphi_1,\lambda_1)$，方向角$\theta$及球面距离$d$，计算目标位置$Q(\varphi_2,\lambda_2)$的公式为：

\begin{align\*}
\varphi_2 &= asin \left( \sin\varphi_1 \cos\delta + \cos\varphi_1 \sin\delta \cos\theta \right)\\\\\\
\lambda_2 &= \lambda_1 + atan2 \frac{\sin\theta \sin\delta \cos\varphi_1}{\cos\delta-\sin\varphi_1 \sin\varphi_2}
\tag{III}
\end{align\*}

其中，球心角$\delta = d/R$。

**推导：**

思路：已知两边及夹角，解球面三角形问题。

根据球面三角形NPQ中的余弦定理，即式\eqref{eq:2}中的第二个式子，可直接得到Q点的纬度值$\varphi_2$。

根据球面三角形NPQ中的正弦定理，即式\eqref{eq:2}中的第一个式子，得到：

$$
\cos\varphi_2 \sin\Delta\lambda = \sin\theta \sin\delta
$$

根据式\eqref{eq:1}可知：

$$
\cos\varphi_2 \cos\Delta\lambda = \frac{\cos\delta - \sin\varphi_1 \sin\varphi_2}{\cos\varphi_1}
$$

以上二式相除：

$$
\tan\Delta\lambda = \frac{\sin\theta \sin\delta \cos\varphi_1}{\cos\delta - \sin\varphi_1 \sin\varphi_2}
$$

从上式即可直接解出Q点的经度$\lambda_2 = \lambda + \Delta\lambda$。


## 参考资料

[^1]: [1] [Calculate distance, bearing and more between Latitude/Longitude points](http://www.movable-type.co.uk/scripts/latlong.html)  

[^2]: [2] [Haversine formula](https://en.wikipedia.org/wiki/Haversine_formula)  

[^3]: [3] [Spherical law of cosines](https://en.wikipedia.org/wiki/Spherical_law_of_cosines)  

[^4]: [4] [Spherical trigonometry](https://en.wikipedia.org/wiki/Spherical_trigonometry) 




